#------------------------------------------------------------------------------
# CORE DATABASE SETTINGS
#------------------------------------------------------------------------------

# Connection Settings
listen_addresses = '*'                      # Listen on all network interfaces
max_connections = 100                       # Maximum number of concurrent connections

# Memory Settings
shared_buffers = 128MB                      # Memory used for shared data cache (25% of RAM recommended for production)
dynamic_shared_memory_type = posix          # Dynamic shared memory implementation type

# Write-Ahead Log (WAL) Settings
max_wal_size = 1GB                          # Maximum size of WAL before checkpoint
min_wal_size = 80MB                         # Minimum size to shrink the WAL to

#------------------------------------------------------------------------------
# LOGGING CONFIGURATION
#------------------------------------------------------------------------------

# General Logging Settings
log_destination = 'stderr'                  # Log output to stderr for Docker/console capture
logging_collector = off                     # Disable log collection (don't write to files)
# The following settings are not needed when logging_collector is off
# log_directory = 'log'
# log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
# log_truncate_on_rotation = off
# log_rotation_age = 1d
# log_rotation_size = 10MB

# Query Logging Settings
log_statement = 'none'                      # Don't log all statements (we'll use log_min_duration_statement instead)
log_duration = off                          # Don't log duration for all statements
log_min_duration_statement = 500            # Only log statements that take longer than 500ms to execute

# Connection Logging Settings
log_connections = off                       # Don't log successful connections
log_disconnections = off                    # Don't log end of sessions
log_hostname = off                          # Log IP addresses only, not hostnames (reduces DNS lookups)
log_checkpoints = on                        # Log checkpoint information
log_lock_waits = on                         # Log when a session waits on a lock
log_temp_files = 0                          # Log information about temporary files
log_line_prefix = '%t [%p]: [%l-1] db=%d,user=%u,app=%a,client=%h '  # Format for log line prefixes

#------------------------------------------------------------------------------
# QUERY STATISTICS AND MONITORING
#------------------------------------------------------------------------------

# Basic Statistics Collection
track_activities = on                       # Collect info about executing commands
track_counts = on                           # Collect statistics on database activity
track_io_timing = on                        # Track timing statistics for I/O calls
track_functions = all                       # Track both SQL and procedural function calls
track_activity_query_size = 2048            # Size reserved for query strings in stats

#------------------------------------------------------------------------------
# AUTOVACUUM SETTINGS
#------------------------------------------------------------------------------

autovacuum = on                             # Enable autovacuum subprocess
log_autovacuum_min_duration = 0             # Log all autovacuum activity

#------------------------------------------------------------------------------
# EXTENSION CONFIGURATIONS
#------------------------------------------------------------------------------

# Preloaded Shared Libraries
shared_preload_libraries = 'pg_stat_statements, auto_explain, vector'  # Extensions to preload

# You also need to enable query identifier calculation for pg_stat_statements to work
compute_query_id = on                        # Required for pg_stat_statements to track queries

# pg_stat_statements Extension Settings
pg_stat_statements.max = 10000              # Maximum number of statements to track
pg_stat_statements.track = all              # Track all statements (top-level and nested)
pg_stat_statements.track_utility = on       # Track utility commands like CREATE TABLE
pg_stat_statements.track_planning = on      # Track planning time statistics
pg_stat_statements.save = on                # Preserve stats across server restarts

# auto_explain Extension Settings
auto_explain.log_min_duration = '500ms'     # Log execution plans for queries taking over 500ms
auto_explain.log_analyze = on               # Log query plans with ANALYZE execution details
auto_explain.log_buffers = on               # Log buffer usage statistics
auto_explain.log_timing = on                # Log timing information for nodes in query plans
auto_explain.log_verbose = on               # Use VERBOSE output for query plans
auto_explain.log_nested_statements = on     # Include nested statements in logs
auto_explain.log_triggers = on              # Include trigger execution statistics
auto_explain.log_settings = on              # Show modified configuration options
auto_explain.log_format = 'json'            # Format of EXPLAIN output (text, xml, json, yaml)
auto_explain.log_level = 'LOG'              # Log level to use for output
auto_explain.sample_rate = 1                # Fraction of statements to log (1=all)